<html>
<head>
    <meta charset="UTF-8">
    <title>websocket测试</title>
    <script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
    <style type="text/css">
        h3, h4 {
            text-align: center;
        }
    </style>
</head>
<body>

<h3>Chat：</h3>
<div id="loginDiv">
    <input id="login" type="text"/>
    <button id="loginButton" type="button" onclick="login()">登录</button>
</div>
<div style="text-align: center">

<textarea id="messageId" readonly="readonly" cols="150" rows="30" style="alignment: center">
</textarea>
</div>

<div style="text-align: center">

    <p>发送给:<input id="target" type="text"></p>
    <textarea id="sendMessage" cols="100" rows="10"></textarea>
    <p>
        <button id="sendButton" type="button" onclick="sendMessage()">发送</button>
    </p>
</div>


<script type="text/javascript">
    var socket;
    let username;

    //简单登录
    function login() {
        username = $("#login").val();
        if (username === '') {
            alert("请输入username");
        } else {
            createWebSocket(username);
            $("#loginDiv").hide();
        }
    }

    function createWebSocket(username) {
        let url = "ws://localhost:8080/chat/{" + username + "}";
        socket = new WebSocket(url);
        socket.onopen = function () {
            let message = {
                message: "onopen method"
            }
            socket.send(JSON.stringify(message));
        }

        socket.onclose = function () {
            console.log("WebSocket close");
        }

        socket.onmessage = function (msg) {
            console.log(msg);
            let data = JSON.parse(msg.data);
            $("#messageId").append("[" + data.from + "]" + data.message + "\n");
        }

        socket.onerror = function () {
            alert("WebSocket error");
        }
    }

    function sendMessage() {
        let target = $("#target").val();
        let sendMessage = $("#sendMessage").val();
        if (target === '') {
            alert("请确定发送人")
        }
        if (sendMessage === '') {
            alert("发送信息不能为空");
        }
        let message = {
            from: username,
            target: target,
            message: sendMessage
        }
        socket.send(JSON.stringify(message));
        //在textarea上记录
        $("#messageId").css("text-align", "right");
        $("#messageId").append(sendMessage + "[" + username + "]" + "\n");
    }

    // if (typeof (WebSocket) == "undefined") {
    //     console.log("遗憾：您的浏览器不支持WebSocket");
    // } else {
    //     console.log("恭喜：您的浏览器支持WebSocket");
    //     //实现化WebSocket对象
    //     //指定要连接的服务器地址与端口建立连接
    //     //注意ws、wss使用不同的端口。我使用自签名的证书测试，
    //     //无法使用wss，浏览器打开WebSocket时报错
    //     //ws对应http、wss对应https。
    //     socket = new WebSocket("ws://localhost:8080/chat/{lilili957}");
    //     //连接打开事件
    //     socket.onopen = function () {
    //         console.log("Socket 已打开");
    //         socket.send("消息发送测试(From Client)");
    //     };
    //
    //     //收到消息事件
    //     socket.onmessage = function (msg) {
    //         $("#messageId").append(msg.data + "\n");
    //         console.log(msg.data);
    //     };
    //     //连接关闭事件
    //     socket.onclose = function () {
    //         console.log("Socket已关闭");
    //     };
    //     //发生了错误事件
    //     socket.onerror = function () {
    //         alert("Socket发生了错误");
    //     }
    //
    //     //窗口关闭时，关闭连接
    //     window.unload = function () {
    //         socket.close();
    //     };
    //     console.log('else end');
    // }
    // setTimeout(() => {
    //     socket.send("测试send方法");
    // }, 3000);
</script>

</body>
</html>